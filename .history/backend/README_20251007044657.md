# TupPhim Backend API

Backend API cho ·ª©ng d·ª•ng TupPhim - User Management & KKPhim API Proxy.

## üöÄ **T√≠nh NƒÉng**

- **User Authentication** - JWT-based authentication system
- **User Management** - Profile, watchlist, favorites, watch history
- **KKPhim API Proxy** - Caching v√† rate limiting cho KKPhim API
- **Security** - Helmet, CORS, rate limiting, input validation
- **Monitoring** - Health checks, logging, performance metrics
- **Database** - MongoDB Atlas cho user data

## üìã **Y√™u C·∫ßu H·ªá Th·ªëng**

- Node.js 18+
- MongoDB Atlas account
- PM2 (cho production)

## üõ†Ô∏è **C√†i ƒê·∫∑t**

### 1. Clone v√† Install Dependencies

```bash
cd backend
npm install
```

### 2. Environment Variables

Copy `env.example` th√†nh `.env` v√† c·∫•u h√¨nh:

```bash
cp env.example .env
```

C·∫•u h√¨nh c√°c bi·∫øn m√¥i tr∆∞·ªùng:

```env
# MongoDB Atlas
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/tuphim_users

# JWT
JWT_SECRET=your-super-secret-jwt-key-here
JWT_EXPIRES_IN=7d

# Server
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:5173

# KKPhim API
KKPHIM_API_BASE=https://phimapi.com
KKPHIM_IMG_BASE=https://phimimg.com
KKPHIM_PLAYER_BASE=https://player.phimapi.com/player/?url=
```

### 3. Ch·∫°y Development Server

```bash
npm run dev
```

Server s·∫Ω ch·∫°y t·∫°i `http://localhost:3001`

## üìö **API Endpoints**

### **Authentication**
- `POST /api/auth/register` - ƒêƒÉng k√Ω user m·ªõi
- `POST /api/auth/login` - ƒêƒÉng nh·∫≠p
- `GET /api/auth/me` - L·∫•y th√¥ng tin user hi·ªán t·∫°i
- `POST /api/auth/refresh` - Refresh JWT token
- `POST /api/auth/change-password` - ƒê·ªïi m·∫≠t kh·∫©u
- `POST /api/auth/logout` - ƒêƒÉng xu·∫•t

### **User Management**
- `GET /api/users/profile` - L·∫•y profile user
- `PUT /api/users/profile` - C·∫≠p nh·∫≠t profile
- `GET /api/users/watchlist` - L·∫•y watchlist
- `POST /api/users/watchlist` - Th√™m v√†o watchlist
- `DELETE /api/users/watchlist/:movieId` - X√≥a kh·ªèi watchlist
- `GET /api/users/favorites` - L·∫•y favorites
- `POST /api/users/favorites` - Th√™m v√†o favorites
- `GET /api/users/history` - L·∫•y watch history
- `POST /api/users/history` - Th√™m v√†o watch history
- `GET /api/users/stats` - L·∫•y th·ªëng k√™ user

### **Movie API (KKPhim Proxy)**
- `GET /api/movies/new` - Phim m·ªõi c·∫≠p nh·∫≠t
- `GET /api/movies/detail/:slug` - Chi ti·∫øt phim
- `GET /api/movies/search` - T√¨m ki·∫øm phim
- `GET /api/movies/categories` - Danh s√°ch th·ªÉ lo·∫°i
- `GET /api/movies/category/:slug` - Phim theo th·ªÉ lo·∫°i
- `GET /api/movies/countries` - Danh s√°ch qu·ªëc gia
- `GET /api/movies/country/:slug` - Phim theo qu·ªëc gia
- `GET /api/movies/year/:year` - Phim theo nƒÉm
- `GET /api/movies/tmdb/:type/:id` - Th√¥ng tin TMDB
- `GET /api/movies/optimize-image` - T·ªëi ∆∞u h√¨nh ·∫£nh
- `GET /api/movies/player-url` - URL tr√¨nh ph√°t

### **Health Check**
- `GET /api/health` - Basic health check
- `GET /api/health/detailed` - Detailed health check
- `GET /api/health/database` - Database health
- `GET /api/health/kkphim-api` - KKPhim API health
- `GET /api/health/ready` - Readiness check
- `GET /api/health/live` - Liveness check

## üîß **Scripts**

```bash
# Development
npm run dev          # Ch·∫°y v·ªõi nodemon

# Production
npm start           # Ch·∫°y production server

# Testing
npm test            # Ch·∫°y tests
npm run test:watch  # Ch·∫°y tests v·ªõi watch mode
```

## üöÄ **Deployment**

### 1. Production Build

```bash
npm install --production
```

### 2. Environment Variables

C·∫•u h√¨nh production environment variables:

```env
NODE_ENV=production
MONGODB_URI=mongodb+srv://...
JWT_SECRET=your-production-secret
FRONTEND_URL=https://yourdomain.com
```

### 3. PM2 Deployment

```bash
# Install PM2 globally
npm install -g pm2

# Start application
pm2 start server.js --name tuphim-backend

# Save PM2 configuration
pm2 save

# Setup PM2 startup
pm2 startup
```

### 4. Nginx Configuration

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## üìä **Monitoring**

### Health Checks

```bash
# Basic health
curl http://localhost:3001/api/health

# Detailed health
curl http://localhost:3001/api/health/detailed

# Database health
curl http://localhost:3001/api/health/database

# KKPhim API health
curl http://localhost:3001/api/health/kkphim-api
```

### Logs

```bash
# PM2 logs
pm2 logs tuphim-backend

# Application logs
tail -f logs/all.log
tail -f logs/error.log
```

## üîí **Security**

- **Helmet.js** - Security headers
- **CORS** - Cross-origin resource sharing
- **Rate Limiting** - 100 requests per 15 minutes
- **JWT Authentication** - Secure token-based auth
- **Input Validation** - Joi validation schemas
- **Password Hashing** - bcrypt with salt rounds 12

## üìà **Performance**

- **Caching** - Node-cache cho KKPhim API responses
- **Rate Limiting** - 100 requests/minute cho KKPhim API
- **Compression** - Gzip compression
- **Database Indexing** - Optimized MongoDB indexes
- **Error Handling** - Graceful error handling v·ªõi fallback data

## üóÑÔ∏è **Database Schema**

### User Collection

```javascript
{
  email: String,
  password: String (hashed),
  username: String,
  fullName: String,
  role: String ('user' | 'admin'),
  preferences: {
    favoriteGenres: [String],
    watchHistory: [{
      movieId: String,
      movieSlug: String,
      movieName: String,
      watchedAt: Date,
      progress: Number
    }],
    watchlist: [{
      movieId: String,
      movieSlug: String,
      movieName: String,
      addedAt: Date
    }],
    favorites: [{
      movieId: String,
      movieSlug: String,
      movieName: String,
      addedAt: Date
    }],
    settings: {
      theme: String,
      language: String,
      notifications: Object
    }
  },
  isActive: Boolean,
  isEmailVerified: Boolean,
  createdAt: Date,
  lastLogin: Date
}
```

## üêõ **Troubleshooting**

### Common Issues

1. **MongoDB Connection Error**
   - Ki·ªÉm tra MONGODB_URI
   - Ki·ªÉm tra network connectivity
   - Ki·ªÉm tra MongoDB Atlas whitelist

2. **JWT Token Error**
   - Ki·ªÉm tra JWT_SECRET
   - Ki·ªÉm tra token expiration
   - Ki·ªÉm tra token format

3. **KKPhim API Error**
   - Ki·ªÉm tra network connectivity
   - Ki·ªÉm tra rate limiting
   - Ki·ªÉm tra API endpoint availability

### Debug Mode

```bash
# Enable debug logging
LOG_LEVEL=debug npm run dev
```

## üìù **API Documentation**

Chi ti·∫øt API documentation c√≥ th·ªÉ xem t·∫°i:
- `http://localhost:3001/api` - API overview
- `http://localhost:3001/api/health` - Health status

## ü§ù **Contributing**

1. Fork the repository
2. Create feature branch
3. Commit changes
4. Push to branch
5. Create Pull Request

## üìÑ **License**

MIT License - xem file LICENSE ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.
